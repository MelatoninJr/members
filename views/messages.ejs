<!DOCTYPE html>
<html>
  <head>
    <title>EJS Mongoose Collection Example</title>
    <link href="/styles/messages.css" rel="stylesheet" type="text/css">
  </head>
  <body>
    <% if (!user) { %>
        <div class="message-page-container">
            <h1 class="message-header">Messages</h1>
            <% messages.forEach(function(message) { %>
                <div class="message-container">
                    <p class="message-content"><%= message.message %></p>
                </div>
        
              <% }); %>
        </div>
      <% } else if (user.membership === 'basic') { %>
        <div class="message-page-container">
            <h1 class="message-header">Messages</h1>
            <form id="update-form">
                <input type="hidden" name="member" value="club">
              </form>
              
              <button type="button" onclick="submitForm()">Update Member</button>
              
              <script>
                async function submitForm() {
                  const formData = new FormData(document.getElementById("update-form"));
                  const response = await fetch('/users/<%= user._id %>', {
                    method: 'PATCH',
                    body: formData
                  });
                  if (response.ok) {
    window.location.reload();
  }
                  console.log(await response.json());
                }
              </script>
              
              
              
              
            <% messages.forEach(function(message) { %>
                <div class="message-container">
                    <p class="message-content"><%= message.message %></p>
                </div>
        
              <% }); %>
        </div>
      <% } else if(user.membership === 'club' || 'admin') { %>
        <div class="message-page-container">
            <h1 class="message-header">Messages</h1>
            <% if (user.membership === 'club') { %>
                <form id="upgrade-form">
                  <input type="hidden" name="membership" value="admin">
                </form>
                <button type="button" onclick="submitUpgradeForm()">Upgrade to Admin</button>
              
                <script>
                  async function submitUpgradeForm() {
                    const formData = new FormData(document.getElementById("upgrade-form"));
                    const response = await fetch('/users/<%= user._id %>', {
                      method: 'PATCH',
                      body: formData
                    });
                    if (response.ok) {
    window.location.reload();
  }
                    console.log(await response.json());
                  }
                </script>
              <% } %>
              
            <form action="/messages" method="post">
                <div>
                  <label for="title">Title:</label>
                  <input type="text" id="title" name="title">
                </div>
                <div>
                  <label for="message">Message:</label>
                  <textarea id="message" name="message"></textarea>
                </div>
                <button type="submit">Submit</button>
              </form>
              
              <% messages.forEach(function(message) { %>
                <div class="message-container">
                  <h1 class="message-title"><%= message.title %></h1>
                  <h3 class="message-author"><%= user.username %></h3>
                  <p class="message-content"><%= message.message %></p>
                  <h6 class="message-date"><%= message.time %></h6>
                  <% if (user.membership === 'admin') { %>
                    <button onclick="deleteMessage('<%= message._id %>')">Delete</button>

                  <% } %>
                </div>
              <% }); %>
              
              <script>
                async function deleteMessage(id) {
                  const response = await fetch(`/messages/${id}`, {
                    method: 'DELETE'
                  });
                  if (response.ok) {
    window.location.reload();
  }
                  console.log(await response.json());
                }
              </script>
              
        </div>
      <% } %>
      %> 
        

  </body>
</html>
